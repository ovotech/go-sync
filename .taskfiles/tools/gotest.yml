version: '3'

includes:
  go-junit-report:
    taskfile: ./go-junit-report.yml
    internal: true


tasks:
  gotest:
    desc: Internal task for running Go tests
    dir: '{{.ROOT_DIR}}'
    internal: true
    cmds:
      - go test -count=1 {{.ARGS}} -v ./... {{.POSTARGS}}

  unit:
    desc: Run unit tests for Go Sync
    dir: '{{.ROOT_DIR}}'
    sources:
      - go.{mod,sum}
      - ./cmd/**/*.go
      - ./internal/**/*.go
      - ./pkg/**/*.go
    cmds:
      - task: gotest

  benchmark:
    desc: Run all Go benchmarks
    dir: '{{.ROOT_DIR}}'
    sources:
      - ./**/*.go
    cmds:
      - task: gotest
        vars:
          ARGS: -bench=. -benchmem -benchtime=10s -run='^DoNotRunTests$$'

  coverage:
    desc: Run tests and generate a coverage report
    dir: '{{.ROOT_DIR}}'
    sources:
      - ./**/*.go
    cmds:
      - task: gotest
        vars:
          ARGS: -covermode=atomic -coverprofile=cover.out

  report:
    desc: Run tests and generate a JUnit XML report
    deps:
      - go-junit-report:install
    dir: '{{.ROOT_DIR}}'
    sources:
      - ./**/*.go
    cmds:
      - task: gotest
        vars:
          POSTARGS: 2>&1 | $GOBIN/go-junit-report -iocopy -out report.xml -set-exit-code

  default:
    desc: Run all gotest tasks
    cmds:
      - task: unit
      - task: benchmark
      - task: coverage
      - task: report
